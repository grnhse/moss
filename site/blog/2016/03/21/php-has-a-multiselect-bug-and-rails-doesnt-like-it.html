<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>PHP Has A Multiselect Bug And Rails Doesn't Like It</title>
  <meta name="description" content="As a solutions engineer at Greenhouse, I speak with many of our customers’ engineers. We engineers approach problems in different ways, using different skill...">

  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://tech.greenhouse.io/2016/03/21/php-has-a-multiselect-bug-and-rails-doesnt-like-it.html">
  <link rel="alternate" type="application/rss+xml" title="In the Weeds - A blog by the Greenhouse Engineering Team" href="https://tech.greenhouse.io/feed.xml" />
  <script src="/javascripts/jquery-2.1.4.js" type="text/javascript"></script>

  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">

  <meta content="In the Weeds - A blog by the Greenhouse Engineering Team" property="og:site_name">
  
    <meta content="PHP Has A Multiselect Bug And Rails Doesn't Like It" property="og:title">
  

  
    <meta content="article" property="og:type">
  

  
    <meta content="a blog by the Greenhouse Engineering team" property="og:description">
  

  
    <meta property="og:url" content="https://tech.greenhouse.io/2016/03/21/php-has-a-multiselect-bug-and-rails-doesnt-like-it.html">
  

  
    <meta content="2016-03-21T00:00:00-04:00" property="article:published_time">
  

  <meta content="http://cdn2.hubspot.net/hub/372554/img/logoNavSmall.png" property="og:image">

  
    
      <meta content="bugs" property="article:tag">
    
      <meta content="php" property="article:tag">
    
  
</head>


  <body>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-67233801-1', 'auto');
  ga('send', 'pageview');

</script>
<header class="site-header">

  <div class="wrapper">

    <div>
      <a href="/">
        <img class="header-icon" src="/images/dandelion.png" alt="dandelion">
      </a>
    </div>
    <a class="site-title" href="/">IN THE WEEDS</a>
    <p class="site-subheader">A BLOG BY THE GREENHOUSE<br>
    ENGINEERING TEAM</p>

  </div>

</header>

<hr class="divider">



    <div class="page-content">
      <div class="wrapper">
  <div class="post">

    

    <header class="post-header">
      <h2 class="post-title">PHP Has A Multiselect Bug And Rails Doesn't Like It</h2>
      <p class="post-meta">Mar 21, 2016 • <a href="https://www.twitter.com/tdphillipsjr" target="_blank">Tom Phillips</a></p>
    </header>


    <article class="post-content">
      <p>As a solutions engineer at Greenhouse, I speak with many of our customers’ engineers. We engineers approach problems in different ways, using different skills. As a result, our customers often have different issues when setting up job boards. Most are easy to diagnose. Is the job board getting cut-off? It’s likely there’s a CSS layer covering it up. Font not carrying over? The source is probably not being sent over HTTPS. API rejecting applications? Probably forgot to base64-encode your API key. So, when one of our customers reported that they were submitting applications to our API, receiving a success response, but never seeing the applications appear in Greenhouse, it seemed likely this was another easily-solved configuration issue.</p>

<p>Turned out, I was wrong.</p>

<p>Full disclosure: I’m a career PHP programmer who had only a passing knowledge of Ruby before coming to Greenhouse. Adapting to the language was a challenge and I still have my moments where I miss access to a good Interface. When a customer was having issues submitting candidates to our API with PHP, I was not expecting to spend days on the problem - primarily because I had solved similar problems before. What I didn’t know was that the trickery I had previously used to get around a particular PHP bug would no longer work.</p>

<p>The PHP Bug in question is <a href="https://bugs.php.net/bug.php?id=51634">found here</a>. In summary, when using PHP’s Curl library, a POST request looks like this:</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$postVars</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;var1&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
    <span class="s1">&#39;var2&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
    <span class="s1">&#39;var3&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;baz&#39;</span>
<span class="p">);</span>
<span class="nv">$ch</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">(</span><span class="s1">&#39;http://www.example.com&#39;</span><span class="p">);</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURL_POST</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURL_POSTFIELDS</span><span class="p">,</span> <span class="nv">$postVars</span><span class="p">);</span>
<span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span></code></pre></div>

<p>The Curl Library (libcurl) translates this array to POST parameters and sends along the request. It does all these things under the hood, so most of the important elements (like the HTTP multi-part boundary string) can’t be accessed outside the library. Mostly, this isn’t a problem. Except with multi-select form inputs. Some customers may want an application question asking the candidate to select the two programming languages they’re most proficient with from a pre-defined list. The customer then needs a way to communicate to our API both of those values tied to the same question. This presents a problem in PHP as the following parameter array will not work:</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">$postVars = array(</span>
<span class="x">    &#39;var1&#39; =&gt; &#39;foo&#39;,</span>
<span class="x">    &#39;var2[]&#39; =&gt; &#39;bar&#39;,</span>
<span class="x">    &#39;var2[]&#39; =&gt; &#39;baz&#39;</span>
<span class="x">);</span></code></pre></div>

<p>When sending the preceding example in to the curl_setopt, only ‘baz’ is sent as a parameter because the second var2[] index overwrites the first. PHP has addressed this problem by allowing the user to set an array index in the hash index:</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">$postVars = array(</span>
<span class="x">    &#39;var1&#39; =&gt; &#39;foo&#39;,</span>
<span class="x">    &#39;var2[0]&#39; =&gt; &#39;bar&#39;,</span>
<span class="x">    &#39;var2[1]&#39; =&gt; &#39;baz&#39;</span>
<span class="x">);</span></code></pre></div>

<p>The problem we ran in to at Greenhouse is that only PHP understands this nomenclature. As a Ruby shop, we expect the Rails convention, in which empty brackets <code>[]</code> indicate multiple values on a single key. In other words, the above code block generates a query string that looks like <code>var2[0]=bar&amp;var2[1]=baz</code> while Rails is expecting (and only understands) <code>var2[]=bar&amp;var2[]=baz</code>. This was preventing Greenhouse from processing the data correctly. To increase the complexity, the form was also required to be encoded as <code>multipart/form-data</code> since we had to accept resumes, cover letters, and any other files the customers wanted to submit. Now the POST parameters start to look like this:</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">$postVars = array(</span>
<span class="x">    &#39;var1&#39; =&gt; &#39;foo&#39;,</span>
<span class="x">    &#39;var2[0]&#39; =&gt; &#39;bar&#39;,</span>
<span class="x">    &#39;var2[1]&#39; =&gt; &#39;baz&#39;,</span>
<span class="x">    &#39;resume&#39; =&gt; new \CURLFile(&#39;/path/to/resume.pdf&#39;,</span>
<span class="x">                              &#39;application/pdf&#39;,</span>
<span class="x">                              &#39;resume&#39;)</span>
<span class="x">);</span></code></pre></div>

<p>Using my slightly out-of-date, pre-<a href="http://php.net/manual/en/class.curlfile.php">CURLFile</a> knowledge of PHP, my workaround plan was to ignore the existence of CURLFile and use the old method of submitting multipart forms, which would have looked something like this:</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">$postVars = &#39;var1=foo&amp;&#39; .</span>
<span class="x">            &#39;var2[]=bar&amp;&#39; .</span>
<span class="x">            &#39;var3[]=baz&amp;&#39; .</span>
<span class="x">            &#39;resume=@/path/to/resume.pdf;filename=resume;type=application/pdf&#39;;</span></code></pre></div>

<p>In the PHP 5.4 and earlier world, this would have worked just fine. It’s a bit of a hack, and ignores the superior and cleaner use of CURLFile, but it would have gotten the customer across the finish line. Unfortunately, my out-of-date PHP knowledge was just that – out of date. In the CURLFile world, the @ sign has been deprecated. Without using deprecated code – which may eventually be unsupported code – there’s no way for PHP to submit a multipart form with a multiselect and file upload to a non PHP system with libcurl.</p>

<p>Enter <a href="http://docs.guzzlephp.org/en/latest/">Guzzle</a>. This incredibly useful library gets around libcurl’s limitations by bypassing it entirely and allowing PHP engineers to send multiselects in a way that non-PHP systems will understand. By giving each parameter its own hash, PHP can send the parameter correctly. Using Guzzle, submitting an application via Greenhouse’s API would look like this:</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">GuzzleHttp\Client</span><span class="p">;</span>

<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">([</span>
    <span class="s1">&#39;base_uri&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;https://api.greenhouse.io/&#39;</span><span class="p">,</span>
<span class="p">]);</span>

<span class="nv">$headers</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;Authorization&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Basic &#39;</span> <span class="o">.</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$_ENV</span><span class="p">[</span><span class="s1">&#39;YOUR_API_KEY&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s1">&#39;:&#39;</span><span class="p">);</span>
<span class="p">);</span>

<span class="nv">$postVars</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;contents&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Tom&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;last_name&#39;</span><span class="p">,</span> <span class="s1">&#39;contents&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;P&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;contents&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;123450&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;contents&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;tom@example.com&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;phone&#39;</span><span class="p">,</span> <span class="s1">&#39;contents&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;555-555-5555&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;question_0000001&#39;</span><span class="p">,</span> <span class="s1">&#39;contents&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;test this stuff&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;question_0000002[]&#39;</span><span class="p">,</span> <span class="s1">&#39;contents&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;0099998&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;question_0000002[]&#39;</span><span class="p">,</span> <span class="s1">&#39;contents&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;0099999&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;resume&#39;</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;resume&#39;</span><span class="p">,</span> <span class="s1">&#39;contents&#39;</span> <span class="o">=&gt;</span> <span class="nb">fopen</span><span class="p">(</span><span class="s1">&#39;/path/to/resume.pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)]</span>
<span class="p">);</span>


<span class="nv">$response</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;v1/applications&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;multipart&#39;</span> <span class="o">=&gt;</span> <span class="nv">$postVars</span><span class="p">,</span>
    <span class="s1">&#39;headers&#39;</span> <span class="o">=&gt;</span> <span class="nv">$headers</span>
<span class="p">));</span></code></pre></div>

<p>The customer is now able to send the correct names for each part of the multiselect, which sidesteps the PHP bug with a widely-used, composer-friendly library.</p>

<p>Because of the bug in PHP’s libcurl, Greenhouse now recommends Guzzle when using PHP to interact with Greenhouse’s API. This is the best option for engineers until such time PHP addresses their libcurl bug.</p>


      
      
        
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
                
            
          
          
          
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
                
            
          
            
          
          
          
            
          
        
      

      <p id="post-meta">Posted with <a href="/blog/tag/bugs/index.html">BUGS</a>, <a href="/blog/tag/php/index.html">PHP</a></p>
    </article>

  </div>

  
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'greenhouseengineeeringblog';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  

</div>

    </div>

    <hr class="divider">

<footer class="site-footer">

  <div class="wrapper">

    <!--<h2 class="footer-heading">In the Weeds - A blog by the Greenhouse Engineering Team</h2>-->

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Greenhouse Engineering</li>
          <li><a href="http://www.greenhouse.io/">Greenhouse.io</a></li>
          <li><a href="http://grnh.se/xt6m8g">We're Hiring!</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <a href="http://www.greenhouse.io/">
        <img class="logo" src="/images/logoWhite.png" alt="white greenhouse logo">
        </a>
      </div>

      <div class="footer-col  footer-col-3">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/grnhse">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">grnhse</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/greenhouse">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">greenhouse</span>
            </a>
          </li>
          
        </ul>
      </div>

      <!--<div class="footer-col  footer-col-3">-->
        <!--<p class="text">a blog by the Greenhouse Engineering team</p>-->
      <!--</div>-->
    </div>

  </div>

</footer>


  </body>

</html>

