<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Effectively Debugging Capybara Feature Specs</title>
  <meta name="description" content="Capybara/Selenium feature specs can be one of the most frustrating types of tests. There is a lot of unexpected behavior and many pieces to keep in mind. Cod...">

  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://tech.greenhouse.io/2015/10/07/effectively-debugging-capybara-feature-specs.html">
  <link rel="alternate" type="application/rss+xml" title="In the Weeds - A blog by the Greenhouse Engineering Team" href="https://tech.greenhouse.io/feed.xml" />
  <script src="/javascripts/jquery-2.1.4.js" type="text/javascript"></script>

  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">

  <meta content="In the Weeds - A blog by the Greenhouse Engineering Team" property="og:site_name">
  
    <meta content="Effectively Debugging Capybara Feature Specs" property="og:title">
  

  
    <meta content="article" property="og:type">
  

  
    <meta content="a blog by the Greenhouse Engineering team" property="og:description">
  

  
    <meta property="og:url" content="https://tech.greenhouse.io/2015/10/07/effectively-debugging-capybara-feature-specs.html">
  

  
    <meta content="2015-10-07T00:00:00-04:00" property="article:published_time">
  

  <meta content="http://cdn2.hubspot.net/hub/372554/img/logoNavSmall.png" property="og:image">

  
    
      <meta content="testing" property="article:tag">
    
      <meta content="capybara" property="article:tag">
    
      <meta content="selenium" property="article:tag">
    
      <meta content="rspec" property="article:tag">
    
  
</head>


  <body>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-67233801-1', 'auto');
  ga('send', 'pageview');

</script>
<header class="site-header">

  <div class="wrapper">

    <div>
      <a href="/">
        <img class="header-icon" src="/images/dandelion.png" alt="dandelion">
      </a>
    </div>
    <a class="site-title" href="/">IN THE WEEDS</a>
    <p class="site-subheader">A BLOG BY THE GREENHOUSE<br>
    ENGINEERING TEAM</p>

  </div>

</header>

<hr class="divider">



    <div class="page-content">
      <div class="wrapper">
  <div class="post">

    

    <header class="post-header">
      <h2 class="post-title">Effectively Debugging Capybara Feature Specs</h2>
      <p class="post-meta">Oct 7, 2015 • <a href="https://www.twitter.com/HanDavid" target="_blank">David Han</a></p>
    </header>


    <article class="post-content">
      <p>Capybara/Selenium feature specs can be one of the most frustrating types of tests. There is a lot of unexpected behavior and many pieces to keep in mind. Code runs in separate threads, and both AJAX behavior and Capybara find methods create timing issues. The aim of this post is to describe a workflow that makes debugging more efficient.</p>

<h3 id="understand-capybara-waiting-behavior">1. Understand Capybara waiting behavior</h3>
<p>Default waiting behavior is the key aspect to understand in writing Capybara specs. The software consultancy thoughtbot has an <a href="https://robots.thoughtbot.com/write-reliable-asynchronous-integration-tests-with-capybara">excellent blog post</a> on writing asynchronous integration tests with Capybara. As the post makes clear, you can use the default wait behavior of many Capybara methods to build a more reliable test that fails less often due to timing issues.
For example:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">expect</span><span class="p">(</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.user&quot;</span><span class="p">)</span><span class="o">[</span><span class="s2">&quot;data-name&quot;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">&quot;Joe&quot;</span><span class="p">)</span></code></pre></div>

<p>The above method lacks waiting behavior since the attribute [“data-name”] is immediately requested. But the method below gains the benefits of default waiting behavior by using a css selector to find the element on the page. </p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_css</span><span class="p">(</span><span class="s2">&quot;.user[data-name=&#39;Joe&#39;]&quot;</span><span class="p">)</span></code></pre></div>

<p>If Capybara cannot find an element immediately, it will keep retrying for a default of two seconds before the spec fails. You can configure the default wait time, which was recently renamed for semantic purposes to default_max_wait_time. Most find methods also have an option that you can pass to configure the wait time. <code>find('.selector', wait: 5)</code></p>

<h3 id="use-break-points">2. Use break points</h3>
<p>I use pry for pretty much every aspect of development as well as for writing tests. My guess is that most developers write Selenium specs by repeatedly writing a few lines of code and running the test. Breakpoints give you a more efficient workflow – just insert a breakpoint, write some code and check that it works before adding to your test. You get a much faster feedback loop, and avoid the guessing and checking that commonly happens with selecting elements on a page. Check out the gif below; it demonstrates the coding process from within a pry breakpoint. Again, just run a command in pry; if it works, copy and paste it into your text editor. </p>

<p><br />
<img src="/images/sign_in.gif" alt="sign in gif" /></p>

<h3 id="tail-the-logs">3. Tail the logs</h3>
<p>There are many benefits to tailing the test logs. You can see errors that don’t bubble up to the UI layer, providing more accurate information when your test fails. You can also see the actions performed on database records and associations. Watching the log is easy – run <code>tail -f log/test.log</code>. </p>

<h3 id="reload-your-objects-before-asserting-object-values">4. Reload your objects before asserting object values</h3>
<p>I often pair with teammates to help debug a spec. Too many times, we’ve gotten stuck on Capybara code that was written perfectly – except for one simple method called <code>reload</code>. Let’s check out an example:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">fill_in</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s1">&#39;David&#39;</span>
<span class="n">click_button</span> <span class="s1">&#39;Save&#39;</span>
<span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="s1">&#39;David&#39;</span></code></pre></div>

<p>Although the above spec seems fine, it will actually fail. Why? The ‘user’ object loaded in memory hasn’t retrieved or reloaded the new data that we modified in the database. Adding a <code>user.reload</code> solves this problem.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">fill_in</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s1">&#39;David&#39;</span>
<span class="n">click_button</span> <span class="s1">&#39;Save&#39;</span>
<span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="s1">&#39;David&#39;</span></code></pre></div>

<p>Side Note: Some may argue that you shouldn’t test your database in a feature spec. After all, a feature spec’s role is to mimic the user’s perspective visiting at a page. We do tread quite lightly on database actions in our feature specs. Most often, we’ll do a light check like this (assuming the <code>click_button('Save')</code> is saving a new user to the database)</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">expect</span> <span class="p">{</span>
  <span class="n">click_button</span> <span class="s1">&#39;Save&#39;</span>
<span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">count</span> <span class="p">}</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></code></pre></div>

<h3 id="test-failure-screenshots">5. Test Failure Screenshots</h3>
<p>We run our test suite on <a href="https://travis-ci.org">TravisCI</a>. Sometimes, specs that pass on a developer’s computer will fail when being run by TravisCI. This can happen for a variety of reasons: timing issues related to hardware differences, poorly written specs that can have side effects, etc.</p>

<p>It can be very difficult to debug these specs. One problem is the lack of tools. You could use <code>puts</code> statements around failing code and watch your TravisCI server logs. This can be time consuming and you’ll still have no idea what’s going on in the view. </p>

<p>A useful alternative is to take a screenshot of the page on failure and to use the <code>travis-artifacts</code> library to upload it to a storage service like <a href="http://aws.amazon.com/s3/">Amazon S3</a>. The documentation on setting up this tool? Let’s say not so hot. Perhaps we can talk about the process in an upcoming blog post.</p>

<h3 id="performance-considerations">6. Performance Considerations</h3>
<p>We use the Selenium driver when developing our tests.  This lets us view how the test runner interacts with the page. For performance reasons, we switch to the <code>capybara-webkit</code> driver once we’re happy with the test.</p>

<p>Tell us what you think in the comments and feel free to share some tips that you use during your everyday writing of Capybara tests.</p>

<p><a href="http://grnh.se/5tebd2">We’re hiring!</a></p>


      
      
        
        
          
            
          
            
          
            
                
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
          
          
            
          
        
          
            
          
            
          
            
          
            
                
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
          
          
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
                
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
          
          
            
          
        
          
            
          
            
          
            
          
            
          
            
                
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
          
          
            
          
        
      

      <p id="post-meta">Posted with <a href="/blog/tag/testing/index.html">TESTING</a>, <a href="/blog/tag/capybara/index.html">CAPYBARA</a>, <a href="/blog/tag/selenium/index.html">SELENIUM</a>, <a href="/blog/tag/rspec/index.html">RSPEC</a></p>
    </article>

  </div>

  
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'greenhouseengineeeringblog';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  

</div>

    </div>

    <hr class="divider">

<footer class="site-footer">

  <div class="wrapper">

    <!--<h2 class="footer-heading">In the Weeds - A blog by the Greenhouse Engineering Team</h2>-->

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Greenhouse Engineering</li>
          <li><a href="http://www.greenhouse.io/">Greenhouse.io</a></li>
          <li><a href="http://grnh.se/xt6m8g">We're Hiring!</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <a href="http://www.greenhouse.io/">
        <img class="logo" src="/images/logoWhite.png" alt="white greenhouse logo">
        </a>
      </div>

      <div class="footer-col  footer-col-3">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/grnhse">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">grnhse</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/greenhouse">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">greenhouse</span>
            </a>
          </li>
          
        </ul>
      </div>

      <!--<div class="footer-col  footer-col-3">-->
        <!--<p class="text">a blog by the Greenhouse Engineering team</p>-->
      <!--</div>-->
    </div>

  </div>

</footer>


  </body>

</html>

